<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Sequencer · Gen.js</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;p&gt;In this chapter we&#x27;ll be modelling a pattern sequencer, namely the&lt;/p&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Sequencer · Gen.js"/><meta property="og:type" content="website"/><meta property="og:url" content="https://meleyal.github.io/gen/"/><meta property="og:description" content="&lt;p&gt;In this chapter we&#x27;ll be modelling a pattern sequencer, namely the&lt;/p&gt;
"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/gen/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css"/><script type="text/javascript" src="/gen/js/custom.js"></script><link rel="stylesheet" href="/gen/css/prism.css"/><link rel="stylesheet" href="/gen/css/main.css"/><script src="/gen/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/gen/"><h2 class="headerTitle">Gen.js</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/gen/docs/introduction" target="_self">Docs</a></li><li class="siteNavGroupActive"><a href="/gen/docs/api/" target="_self">API</a></li><li class=""><a href="https://github.com/meleyal/gen" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Examples</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Welcome</h3><ul class=""><li class="navListItem"><a class="navItem" href="/gen/docs/introduction">Introduction</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Primers</h3><ul class=""><li class="navListItem"><a class="navItem" href="/gen/docs/primers/generative">Generative</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/primers/music">Music</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/primers/javascript">JavaScript</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Examples</h3><ul class=""><li class="navListItem"><a class="navItem" href="/gen/docs/examples/sampler">Sampler</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/examples/metronome">Metronome</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/gen/docs/examples/sequencer">Sequencer</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/examples/walker">Walker</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">API</h3><ul class=""><li class="navListItem"><a class="navItem" href="/gen/docs/api/">API Reference</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Appendix</h3><ul class=""><li class="navListItem"><a class="navItem" href="/gen/docs/appendix/links">Links</a></li><li class="navListItem"><a class="navItem" href="/gen/docs/appendix/forms">Forms</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              const headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                if (event.target.tagName === 'A') {
                  document.body.classList.remove('tocActive');
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Sequencer</h1></header><article><div><span><p>In this chapter we'll be modelling a pattern sequencer, namely the
<a href="https://www.propellerheads.com/en/reason/recording/matrix">Matrix</a> sequencer
found in Reason by Propellerhead Software. This is not strictly a generative
idea, but it will give us a structure on which to plug in more generative ideas
later. Being able to generate and sequence patterns will help us build up more
complete musical structures.</p>
<p>The Matrix sequencer lets you draw in a pattern of notes and their velocities.
It plays each step of the pattern one at a time, then loops back around to the
start. A rest (no note) is just a note with 0 velocity. The number of steps
(i.e. the length) of the pattern can be adjusted, as well as the &quot;resolution&quot;,
or how fast the sequencer steps through the pattern. If a pattern of 16 steps at
1/16 resolution is full speed, the same pattern at 1/8 resolution would play
back at half that speed. In other words each step would last twice as long.
Patterns are stored in banks and can also be sequenced, automatically cycling or
jumping between them. Patterns can be copied and pasted between banks to serve
as the basis for new patterns.</p>
<p>The relevant parts of the interface are highlighted below:</p>
<p><img src="/gen/docs/assets/sequencer/matrix.png" alt=""></p>
<p>How might we go about modelling this?</p>
<h2><a class="anchor" aria-hidden="true" id="patterns"></a><a href="#patterns" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Patterns</h2>
<p>At it's most basic, a pattern is just an array of note values:</p>
<pre><code class="hljs css language-js"><span class="token comment">//               C   .   .   D   .   .   .   .   .   E   F#  G#  .   .   .   .</span>
<span class="token keyword">const</span> pattern <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">]</span>

pattern<span class="token punctuation">.</span>length <span class="token comment">// => 16</span>
</code></pre>
<p>To also model velocity, we can make each value an array (or tuple):</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> pattern <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span>
</code></pre>
<p>Being that our pattern is just an array, it's easy to copy and alter it:</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> pattern2 <span class="token operator">=</span> <span class="token function">flow</span><span class="token punctuation">(</span>
  <span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  shuffle
<span class="token punctuation">)</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pattern2<span class="token punctuation">)</span> <span class="token comment">/* =>
[
  [60, 127],
  [60, 127],
  [62, 127],
  [62, 127],
  [62, 127],
  [60, 127],
  [62, 127],
  [62, 127]
]
*/</span>

pattern2<span class="token punctuation">.</span>length <span class="token comment">// => 8</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="steps"></a><a href="#steps" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Steps</h2>
<p>To step through the pattern, we just need a counter to keep track of the current
step and use that as an index into the pattern array:</p>
<pre><code class="hljs css language-js"><span class="token keyword">let</span> step <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> pattern <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span>

<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`s</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>step <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pattern<span class="token punctuation">[</span>step<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>step <span class="token operator">&lt;</span> pattern<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    step <span class="token operator">+=</span> <span class="token number">1</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    step <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>

<span class="token comment">/*

Output:

s1 : 60,127
s2 : 60,127
s3 : 62,127
s4 : 62,127
s5 : 62,127
s6 : 60,127
s7 : 62,127
s8 : 62,127
s1 : 60,127
s2 : 60,127
...

*/</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="resolution"></a><a href="#resolution" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Resolution</h2>
<p>Resolution is slightly more tricky, but this is where our
<a href="../api/metro"><code>metro</code></a> utility will come in handy.</p>
<p>The Matrix sequencer supports the following resolutions: 1/2, 1/4, 1/8, 1/16,
1/32, 1/64 and 1/128 (plus some triplet divisions which we'll ignore for now).</p>
<p>If we presume a time signature of 4/4 (4 beats per bar), the resolutions break
down as follows:</p>
<p><img src="/gen/docs/assets/sequencer/resolution.svg" alt=""></p>
<p>As we saw in the <a href="../primers/music">Music chapter</a>, in traditional music
notation we might call these divisions a &quot;half note&quot; or &quot;quarter note&quot;, (or
&quot;minim&quot; or &quot;crotchet&quot;), while in a pattern sequencer they are usually
represented as fractions. Both refer to the same thing: how to subdivide a bar.</p>
<p>Let's say our metronome is ticking away at 60 bpm, meaning each beat lasts 1
second. A bar of 4 beats will therefore last 4 seconds, or 4000 milliseconds.
Knowing this, we just need to divide the bar length by the resolution to give us
the length of our notes.</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> bpm <span class="token operator">=</span> <span class="token number">60</span>
<span class="token keyword">const</span> beat <span class="token operator">=</span> <span class="token punctuation">(</span>bpm <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token comment">// 1000ms = 1s</span>
<span class="token keyword">const</span> bar <span class="token operator">=</span> beat <span class="token operator">*</span> <span class="token number">4</span> <span class="token comment">// 4000ms = 4s</span>

bar <span class="token operator">/</span> <span class="token number">1</span> <span class="token comment">// => 4000</span>
bar <span class="token operator">/</span> <span class="token number">2</span> <span class="token comment">// => 2000</span>
bar <span class="token operator">/</span> <span class="token number">4</span> <span class="token comment">// => 1000</span>
bar <span class="token operator">/</span> <span class="token number">8</span> <span class="token comment">// => 500</span>
bar <span class="token operator">/</span> <span class="token number">16</span> <span class="token comment">// => 250</span>
bar <span class="token operator">/</span> <span class="token number">32</span> <span class="token comment">// => 125</span>
bar <span class="token operator">/</span> <span class="token number">64</span> <span class="token comment">// => 62.5</span>
bar <span class="token operator">/</span> <span class="token number">128</span> <span class="token comment">// => 31.25</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="sequencing"></a><a href="#sequencing" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sequencing</h2>
<p>If we define our pattern &quot;bank&quot; as just an array of patterns, then moving
between patterns is similar to progressing through the individual steps of a
pattern:</p>
<pre><code class="hljs css language-js"><span class="token keyword">let</span> pattern <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">let</span> step <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> patterns <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">]</span>

<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`p</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pattern <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : s</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>step <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>patterns<span class="token punctuation">[</span>pattern<span class="token punctuation">]</span><span class="token punctuation">[</span>step<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>step <span class="token operator">&lt;</span> patterns<span class="token punctuation">[</span>pattern<span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    step <span class="token operator">+=</span> <span class="token number">1</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    step <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pattern <span class="token operator">&lt;</span> patterns<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pattern <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      pattern <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>

<span class="token comment">/*

Output:

p1 : s1 : 60,127
p1 : s2 : 60,127
p1 : s3 : 62,127
p1 : s4 : 62,127
p1 : s5 : 62,127
p1 : s6 : 60,127
p1 : s7 : 62,127
p1 : s8 : 62,127
p2 : s1 : 62,127
p2 : s2 : 64,127
p2 : s3 : 66,127
...

*/</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="first-version"></a><a href="#first-version" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>First version</h2>
<p>Putting this all together, we can already build a basic version of our pattern
sequencer:</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> bpm <span class="token operator">=</span> <span class="token number">60</span>
<span class="token keyword">const</span> beat <span class="token operator">=</span> <span class="token punctuation">(</span>bpm <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token comment">// 1000ms = 1s</span>
<span class="token keyword">const</span> bar <span class="token operator">=</span> beat <span class="token operator">*</span> <span class="token number">4</span> <span class="token comment">// 4000ms = 4s</span>
<span class="token keyword">const</span> resolution <span class="token operator">=</span> <span class="token number">4</span>
<span class="token keyword">const</span> length <span class="token operator">=</span> bar <span class="token operator">/</span> resolution

<span class="token keyword">let</span> pattern <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">let</span> step <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> patterns <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">]</span>

navigator<span class="token punctuation">.</span><span class="token function">requestMIDIAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">midi</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> outputs <span class="token operator">=</span> midi<span class="token punctuation">.</span>outputs<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> output <span class="token operator">=</span> outputs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value

  <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`p</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pattern <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : s</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>step <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>patterns<span class="token punctuation">[</span>pattern<span class="token punctuation">]</span><span class="token punctuation">[</span>step<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> <span class="token punctuation">[</span>note<span class="token punctuation">,</span> velocity<span class="token punctuation">]</span> <span class="token operator">=</span> patterns<span class="token punctuation">[</span>pattern<span class="token punctuation">]</span><span class="token punctuation">[</span>step<span class="token punctuation">]</span>
    output<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x90</span><span class="token punctuation">,</span> note<span class="token punctuation">,</span> velocity<span class="token punctuation">]</span><span class="token punctuation">)</span>
    output<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x80</span><span class="token punctuation">,</span> note<span class="token punctuation">,</span> velocity<span class="token punctuation">]</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> length<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>step <span class="token operator">&lt;</span> patterns<span class="token punctuation">[</span>pattern<span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      step <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      step <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>pattern <span class="token operator">&lt;</span> patterns<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pattern <span class="token operator">+=</span> <span class="token number">1</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        pattern <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="generators"></a><a href="#generators" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Generators</h2>
<blockquote>
<p>TODO: Research if Generator functions would be useful here.</p>
</blockquote>
<p>It would be nice if we could avoid writing out all of our patterns by hand. This
is a book on generative music after all! For this purpose, we'll introduce the
concept of &quot;generators&quot;. In this context, a generator is just a name we'll give
to something that produces a pattern (not to be confused with
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function*">JavaScript generator functions</a>).</p>
<p>We'll start simple, and reuse some of our learning from the previous chapter to
generate a random pattern for our sequencer to play back.</p>
<pre><code class="hljs css language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> limit<span class="token punctuation">,</span> scale <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'gen'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  flow<span class="token punctuation">,</span>
  sample<span class="token punctuation">,</span>
  random<span class="token punctuation">,</span>
  shuffle<span class="token punctuation">,</span>
  take<span class="token punctuation">,</span>
  fill<span class="token punctuation">,</span>
  map<span class="token punctuation">,</span>
  reverse
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'lodash/fp'</span>

<span class="token keyword">const</span> pattern1 <span class="token operator">=</span> <span class="token function">flow</span><span class="token punctuation">(</span>
  <span class="token function">scale</span><span class="token punctuation">(</span><span class="token string">'cmaj'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">limit</span><span class="token punctuation">(</span><span class="token string">'piano'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  shuffle<span class="token punctuation">,</span>
  <span class="token function">take</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token operator">=></span> <span class="token punctuation">[</span>n<span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> bpm <span class="token operator">=</span> <span class="token number">60</span>
<span class="token keyword">const</span> beat <span class="token operator">=</span> <span class="token punctuation">(</span>bpm <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token comment">// 1000ms = 1s</span>
<span class="token keyword">const</span> bar <span class="token operator">=</span> beat <span class="token operator">*</span> <span class="token number">4</span> <span class="token comment">// 4000ms = 4s</span>
<span class="token keyword">const</span> resolution <span class="token operator">=</span> <span class="token number">16</span>
<span class="token keyword">const</span> length <span class="token operator">=</span> bar <span class="token operator">/</span> resolution

<span class="token keyword">let</span> pattern <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">let</span> step <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> patterns <span class="token operator">=</span> <span class="token punctuation">[</span>pattern1<span class="token punctuation">,</span> <span class="token function">reverse</span><span class="token punctuation">(</span>pattern1<span class="token punctuation">)</span><span class="token punctuation">]</span>

navigator<span class="token punctuation">.</span><span class="token function">requestMIDIAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">midi</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> outputs <span class="token operator">=</span> midi<span class="token punctuation">.</span>outputs<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> output <span class="token operator">=</span> outputs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value

  <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`p</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pattern <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : s</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>step <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>patterns<span class="token punctuation">[</span>pattern<span class="token punctuation">]</span><span class="token punctuation">[</span>step<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> <span class="token punctuation">[</span>note<span class="token punctuation">,</span> velocity<span class="token punctuation">]</span> <span class="token operator">=</span> patterns<span class="token punctuation">[</span>pattern<span class="token punctuation">]</span><span class="token punctuation">[</span>step<span class="token punctuation">]</span>
    output<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x90</span><span class="token punctuation">,</span> note<span class="token punctuation">,</span> velocity<span class="token punctuation">]</span><span class="token punctuation">)</span>
    output<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x80</span><span class="token punctuation">,</span> note<span class="token punctuation">,</span> velocity<span class="token punctuation">]</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> length<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>step <span class="token operator">&lt;</span> patterns<span class="token punctuation">[</span>pattern<span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      step <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      step <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>pattern <span class="token operator">&lt;</span> patterns<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pattern <span class="token operator">+=</span> <span class="token number">1</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        pattern <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>Here, we're shuffling the notes of the scale, then taking 16 of them to produce
a random pattern. To introduce some symmetry, our second pattern is just our
first pattern reversed.</p>
<h2><a class="anchor" aria-hidden="true" id="seeding"></a><a href="#seeding" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Seeding</h2>
<p>We can now reload the browser and get a new random pattern each time. But what
if we hit upon a pattern we like? If we reload, our pattern will be lost forever
(or at least has only a small chance of occurring again).</p>
<p>Random number generators often let you provide a &quot;seed&quot; for the purpose of
reproducing randomness. Given the same seed, you'll always get the same result.</p>
<p>The Lodash <code>shuffle</code> function we're using here relies on JS' native
<code>Math.random()</code> function, which unfortunately doesn't support seeding.</p>
<p>Luckily there's <a href="https://github.com/davidbau/seedrandom"><code>seedrandom</code></a> which
replaces <code>Math.random()</code> with a seedable version.</p>
<p>TODO: Can we just overwrite/mixin a custom <code>random()</code> function?
<a href="https://github.com/lodash/lodash/issues/3289#issuecomment-434854622">https://github.com/lodash/lodash/issues/3289#issuecomment-434854622</a></p>
<pre><code class="hljs css language-js"><span class="token keyword">import</span> seedrandom <span class="token keyword">from</span> <span class="token string">'seedrandom'</span>
<span class="token keyword">import</span> cryptoRandomString <span class="token keyword">from</span> <span class="token string">'crypto-random-string'</span>

<span class="token comment">// const seed = 'hello'</span>
<span class="token keyword">const</span> seed <span class="token operator">=</span> <span class="token function">cryptoRandomString</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'seed:'</span><span class="token punctuation">,</span> seed<span class="token punctuation">)</span>

<span class="token keyword">const</span> rng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">seedrandom</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token parameter">lower<span class="token punctuation">,</span> upper</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> lower <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token function">rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>upper <span class="token operator">-</span> lower <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">shuffle</span><span class="token punctuation">(</span><span class="token parameter">collection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>collection<span class="token punctuation">]</span><span class="token punctuation">,</span>
    length <span class="token operator">=</span> result<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
    lastIndex <span class="token operator">=</span> length <span class="token operator">-</span> <span class="token number">1</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">++</span>index <span class="token operator">&lt;</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> rand <span class="token operator">=</span> <span class="token function">random</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> lastIndex<span class="token punctuation">)</span>
    result<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">[</span>rand<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">shuffle</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="transforms"></a><a href="#transforms" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Transforms</h2>
<p>We've already seen how we can produce a new pattern based on an existing one via
reversing it. The beauty of our patterns being arrays is that they're easy to
slice and dice using built-in functions, or anything that works with arrays,
such as the Lodash array and collection functions.</p>
<p>This can be useful for creating both melodies and harmonies. Melodies might
reuse the same notes in a different order to create a variation, while harmonies
might play the same notes in a lower octave on a different instrument.</p>
<p>We'll refer to this as &quot;transforming&quot; a pattern, and there are many ways we
could do it:</p>
<p><img src="/gen/docs/assets/sequencer/transforms.svg" alt=""></p>
<p>And here's how these transformations might look in code:</p>
<pre><code class="hljs css language-js"><span class="token keyword">const</span> original <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> <span class="token function-variable function">reverse</span> <span class="token operator">=</span> <span class="token parameter">arr</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token operator">...</span>arr<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// TODO: Handle positive and negative steps > 1</span>
<span class="token keyword">const</span> <span class="token function-variable function">nudge</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> step <span class="token operator">=</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> _arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>arr<span class="token punctuation">]</span>
  <span class="token keyword">const</span> last <span class="token operator">=</span> _arr<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  _arr<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>last<span class="token punctuation">)</span>
  <span class="token keyword">return</span> _arr
<span class="token punctuation">}</span>

<span class="token comment">// TODO</span>
<span class="token keyword">const</span> <span class="token function-variable function">shuffle</span> <span class="token operator">=</span> <span class="token parameter">arr</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">...</span>arr<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">transpose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> step <span class="token operator">=</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token operator">=></span> n <span class="token operator">+</span> step<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">swap</span> <span class="token operator">=</span> <span class="token parameter">arr</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> a <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=></span> idx <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> b <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=></span> idx <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> a<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span>n<span class="token punctuation">,</span> b<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

original <span class="token comment">// => 1,2,3,4</span>
<span class="token function">reverse</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span> <span class="token comment">// => 4,3,2,1</span>
<span class="token function">nudge</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span> <span class="token comment">// => 4,1,2,3</span>
<span class="token function">shuffle</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span> <span class="token comment">// => 3,2,1,4</span>
<span class="token function">transpose</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span> <span class="token comment">// => 2,3,4,5</span>
<span class="token function">swap</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span> <span class="token comment">// => 2,1,4,3</span>
</code></pre>
<p>It should be noted that our patterns <em>are</em> technically
<a href="https://en.wikipedia.org/wiki/Matrix_(mathematics)">matrices</a> (or vectors),
and that matrix transformation is a rich topic, but beyond the scope of this
book.</p>
<h2><a class="anchor" aria-hidden="true" id="learning"></a><a href="#learning" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Learning</h2>
<p>Before proceeding, let's encapsulate our learning so far.</p>
<ul>
<li><p><strong>Generating patterns:</strong> Functions for generating new patterns →
<a href="../api/gen"><code>gen</code></a>.</p></li>
<li><p><strong>Transforming patterns:</strong> Functions for transforming patterns →
<a href="../api/?"><code>array/collection/transform/pattern</code></a>.</p></li>
<li><p><strong>Sequencing patterns:</strong> Functions for sequencing patterns →
<a href="../api/seq"><code>seq</code></a>.</p></li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="second-version"></a><a href="#second-version" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Second version</h2>
<p>Let's combine the above ideas into a new and improved version of our pattern
sequencer.</p>
<pre><code class="hljs css language-js"></code></pre>
<h2><a class="anchor" aria-hidden="true" id="harmony"></a><a href="#harmony" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Harmony</h2>
<p>2 part harmony 4 part harmony</p>
</span></div></article></div><div class="docLastUpdate"><em>Last updated on 5/8/2019</em></div><div class="docs-prevnext"><a class="docs-prev button" href="/gen/docs/examples/metronome"><span class="arrow-prev">← </span><span>Metronome</span></a><a class="docs-next button" href="/gen/docs/examples/walker"><span>Walker</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#patterns">Patterns</a></li><li><a href="#steps">Steps</a></li><li><a href="#resolution">Resolution</a></li><li><a href="#sequencing">Sequencing</a></li><li><a href="#first-version">First version</a></li><li><a href="#generators">Generators</a></li><li><a href="#seeding">Seeding</a></li><li><a href="#transforms">Transforms</a></li><li><a href="#learning">Learning</a></li><li><a href="#second-version">Second version</a></li><li><a href="#harmony">Harmony</a></li></ul></nav></div></div></body></html>